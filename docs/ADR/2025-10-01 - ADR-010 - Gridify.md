# ADR-009: Adopt Gridify for Query Filtering, Sorting, and Searching

## Status
Decided

## Context
Our application requires a flexible and consistent approach for **sorting, filtering, and searching** across both **flat** and **nested properties (commonly up to 2 levels, occasionally deeper)**. Clients must be able to express queries without relying on custom endpoints for every variation.  

The chosen solution must:  
- Prevent malicious or overly complex queries  
- Integrate seamlessly with Entity Framework Core for efficient SQL generation  
- Avoid the need to manually implement custom filters for every nested property  
- Offer a **clean and developer-friendly client syntax**  

We evaluated **OData**, **Sieve**, and **Gridify**. OData provides very rich query semantics but is verbose, complex to set up, and risky when exposing unrestricted navigation expansions. Sieve is lightweight and developer-friendly but limited to shallow property filtering without heavy customization. Gridify strikes a balance by offering **nested property support out-of-the-box** with a lightweight client syntax.

## Decision
We will adopt **Gridify** as the solution for query filtering, sorting, and searching.

## Rationale

**Supports Nested Queries Without Boilerplate**
- Out-of-the-box support for 2+ levels of navigation properties  
- Avoids the need for writing custom filter logic for each nested property  
- Works seamlessly with EF Core, translating queries directly to SQL  

**Client-Friendly Query Syntax**
- Concise and readable query format (`Orders.Items.Product.Name=="Pizza"`)  
- Easier to consume compared to verbose OData `$filter` and `$expand` clauses  
- Reduces client-side complexity and improves developer productivity  

**Security and Control**
- Property mappings and whitelisting allow explicit control over exposed fields  
- Prevents clients from querying sensitive or unsupported properties  
- Can enforce query limits (e.g., pagination, max depth) to avoid performance abuse  

**Lightweight and Easy to Integrate**
- Minimal configuration required for EF Core integration  
- No dependency on heavy protocols (unlike OData)  
- Clear documentation and active development  

## Consequences

### Positive
- ✅ Native support for filtering on nested navigation properties (2+ levels)  
- ✅ Clean, simple, client-friendly syntax compared to OData  
- ✅ Avoids writing custom filter classes for every nested property scenario  
- ✅ Works seamlessly with EF Core and LINQ  
- ✅ Explicit control over exposed properties enhances security  
- ✅ Lightweight with minimal setup and learning curve  

### Negative
- ⚠️ Smaller ecosystem and community compared to OData  
- ⚠️ Less of a “standard” compared to OData, meaning new developers may need orientation  
- ⚠️ For very complex queries (3+ joins or deep expansions), performance must be monitored and tuned  
- ⚠️ Slightly less flexibility than OData in partial projections within nested queries  

### Implementation Notes
- Configure Gridify mappings at startup to whitelist allowed entity properties  
- Place Gridify configuration in `Application/Query/Filters` folder for maintainability  
- Use `ApplyFiltering()`, `ApplyOrdering()`, and `ApplyPaging()` directly on EF Core `IQueryable`  
- Validate critical queries with integration tests to ensure expected SQL translation  
- Apply global constraints (e.g., max page size, allowed depth) to prevent abuse  
- Provide client-side documentation/examples to ensure proper query usage  

## Alternatives Considered

**OData**: Rejected due to verbose syntax, complex setup, and performance/security risks from uncontrolled `$expand` and `$filter`.  

**Sieve**: Rejected due to limited nesting support, requiring custom filter implementations for each multi-level property, which is not scalable.  

**Manual Filtering Logic**: Rejected due to high boilerplate, poor maintainability, and duplication of query logic across endpoints.  

## References
- Gridify Official Documentation (https://github.com/alirezanet/Gridify)  
- OData vs Sieve vs Gridify Comparison (internal evaluation)  
- EF Core Query Performance Best Practices  
